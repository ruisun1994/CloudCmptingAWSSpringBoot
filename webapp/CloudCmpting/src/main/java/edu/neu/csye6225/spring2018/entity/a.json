{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Sample CloudFormation Template for CSYE 6225 - Spring 2018",
  "Mappings" : {
    "RegionMap": {
      "us-east-1": {
        "32": "ami-6411e20d",
        "64": "ami-7a11e213"
      }
    }
  },
  "Conditions" : {
  },
  "Parameters": {
    "KeyName": {
      "Description" : "Name of an existing EC2 key pair for SSH access to the EC2 instance.",
      "Type": "AWS::EC2::KeyPair::KeyName"
    },
    "STACK_NAME": {
      "Type": "String"
    }
  },
  "Resources": {
    "myVPC": {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : "10.0.0.0/16",
        "AvailabilityZone" : "us-east-1a",
        "Tags" : [ {"Name" : { "Fn::Join" : [ "", [ {"Ref" : "STACK_NAME"}, "-csye6225-vpc" ] ]} }]
      }
    },
    "mySubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": {
          "Ref": "myVPC"
        },
        "CidrBlock": "10.0.0.0/24",
        "VpcId": {
          "Ref": "myVPC"
        }
      }
    },
    "mySubnet2": {
      "Type" : "AWS::EC2::Subnet",
      "Properties" : {
        "AvailabilityZone" : { "Ref" : "myVPC"},
        "CidrBlock" : "10.0.1.0/24",
        "VpcId" : { "Ref" : "myVPC"}
      }
    },
    "myInternetGateway": {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [ {"Name" : { "Fn::Join" : [ "", [ {"Ref" : "STACK_NAME"}, "-csye6225-InternetGateway" ] ]} }]
      }
    },
    "myAttachGateway" : {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "myVPC"
        },
        "InternetGatewayId": {
          "Ref": "myInternetGateway"
        }
      }
    },
    "myRouteTable": {
      "Type" : "AWS::EC2::RouteTable",
      "Properties" : {
        "VpcId" : { "Ref" : "myVPC" },
        "Tags" : [ {"Name" : { "Fn::Join" : [ "", [ {"Ref" : "STACK_NAME"}, "-csye6225-public-route-table" ] ]} }]
      }
    },
    "myRoute": {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : "GatewayToInternet",
      "Properties" : {
        "RouteTableId" : { "Ref" : "myRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "myInternetGateway" }
      }
    },
    "mySubnet1RouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "Properties" : {
        "SubnetId" : { "Ref" : "mySubnet1" },
        "RouteTableId" : { "Ref" : "myRouteTable" }
      }
    },
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": "csye6225-Spring2018-aws",
        "GroupDescription": "Enable HTTP access via port 80, SSH access via port 22, HTTPS access via port 443",
        "VpcId": {
          "Ref": "myVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "EC2Instance": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "32"]},
        "InstanceType": "t2.micro",
        "SecurityGroupIds": [
          {"Ref": "InstanceSecurityGroup"}
        ],
        "KeyName": {
          "Ref": "ParamKeyName"
        },
        "SubnetId": {
          "Ref": "mySubnet1"
        },
        "Tags" : [ {"Name" : { "Fn::Join" : [ "", [ {"Ref" : "STACK_NAME"}, "-csye6225-instance" ] ]} }]
      }
    }
  }
}