{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description" : "csye6225 spring",
    "Resources" : {
       "MyEC2Instance" : {
          "Type" : "AWS::EC2::Instance",
          "Properties" : {
             "ImageId" : "ami-41e0b93b",
             "InstanceType" : "t2.micro",
	     "KeyName" : "DONGQI",
	     "SubnetId" : {"Ref" : "SubnetId"},
	     "SecurityGroupIds" : [{"Ref" : "WebPolicy"}],
             "DisableApiTermination" : "false",
	     "IamInstanceProfile" : {"Ref":"ec2instanceprofile"},
             "InstanceInitiatedShutdownBehavior" : "stop",
	     "UserData": {
          	"Fn::Base64": {
            	"Fn::Join": [
              	"",
              [
                "#!/bin/bash -xe\n",
                "sudo apt-get update\n",
                "sudo apt-get install openjdk-8-jdk -y\n",
                "sudo apt-get install ruby -y\n",
                "sudo apt-get install wget -y\n",
                "sudo apt-get install python -y\n",
                "sudo apt-get update\n",
                "sudo wget https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install\n",
                "sudo chmod +x ./install\n",
                "sudo ./install auto\n",
                "sudo service codedeploy-agent start\n",
                "sudo apt-get install tomcat8 -y\n",
		"sudo mkdir /var/tempimage\n",
		"sudo chown -R ubuntu /var/tempimage\n",
                "sudo echo \"JAVA_OPTS=\\\"\\${JAVA_OPTS} -Dspring.datasource.username=csye6225master -Dspring.datasource.password=csye6225password  -Dspring.profiles.active=aws\\\"\" >> /etc/default/tomcat8\n",
                {
                  "Fn::Join": [
                    "",
                    [
                      "echo 'JAVA_OPTS=\"${JAVA_OPTS} -Dspring.datasource.url=\\\"jdbc:mysql://",
                      {
                        "Fn::GetAtt": [
                          "MyDB",
                          "Endpoint.Address"
                        ]
                      },
                      ":3306/csye6225\\\"\"' >> /etc/default/tomcat8\n"
                    ]
                  ]
                },
                "sudo service tomcat8 restart\n"
              ]
            ]
          }
        },
             "BlockDeviceMappings" : [
                {
                   "DeviceName" : "/dev/sda1",
                   "Ebs" : {
                      "VolumeType" : "gp2",
                      "DeleteOnTermination" : "false",
                      "VolumeSize" : "16"
                   }
                }
             ],
             "Tags" : [
                {
                    "Key" : "Name",
                    "Value" : {"Ref":"InstanceName"}
                },
		{   
		    "Key" : "deploy",
		    "Value" : "deploy"
		}
             ]
          }
       },

       "ec2instanceprofile" : {
	    "Type": "AWS::IAM::InstanceProfile",
   	    "Properties": {
      	        "Path": "/",
                "Roles": ["CodeDeployEC2ServiceRole"],
                "InstanceProfileName": "ec2profile"
             }
	},

      "myDynamoDBTable" : {
      "Type" : "AWS::DynamoDB::Table",
      "Properties" : {
        "AttributeDefinitions" : [
          {
            "AttributeName" : "id",
            "AttributeType" : "S"   
          }
        ],
        "KeySchema" : [
          {
            "AttributeName" : "id",
            "KeyType" : "HASH"
          }
        ],
        "ProvisionedThroughput" : {
          "ReadCapacityUnits" : "5",
          "WriteCapacityUnits" : "5"
        },
        "TableName" : "csye6225"
      }
    },
    "RecordServiceS3Bucket" : {
	"Type" : "AWS::S3::Bucket",
  	"Properties" : {
	    "BucketName" : "s3.csye6225-spring2018-guodong.me"
	 }
     },

  "MyDB" : {
   "Type" : "AWS::RDS::DBInstance",
   "Properties" : {
      "DBName" : "csye6225",
      "Engine" : "MySQL",
      "EngineVersion" : "5.6.37",
      "DBInstanceClass" : "db.t2.medium",
      "MultiAZ" : "false",
      "DBInstanceIdentifier" : "csye6225-spring2018",
      "MasterUsername" : "csye6225master",
      "MasterUserPassword" : "csye6225password",
      "DBSubnetGroupName" : {"Ref":"DBSubnetGroup"},
      "VPCSecurityGroups" : [{
	   "Ref" : "DBPolicy"
	}],
      "PubliclyAccessible" : "false",
      "Tags" : [ { "Key" : "Name", "Value" : "csye6225" } ],
      "AllocatedStorage" : "10"
   }
}

    },
    "Parameters" : {
        "InstanceName" : {
            "Type" : "String"
        },
	"SubnetId" : {
	    "Type" : "String"
	},
	"WebPolicy" : {
	    "Type" : "String"
	},
	"DBPolicy" : {
	    "Type" : "String"
	},
	"DBSubnetGroup" : {
	    "Type" : "String"
	}
    }
 }        
 
 
