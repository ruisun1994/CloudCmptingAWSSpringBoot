{
    "Resources": {
      "CodeDeployEC2S3": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
	"Roles" : [{"Ref":"CodeDeployEC2ServiceRole"}],
        "PolicyName": "CodeDeploy-EC2-S3",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": [
                "s3:Get*",
                "s3:List*",
		"s3:Put*",
		"s3:Delete*"
              ],
              "Effect": "Allow",
              "Resource": "arn:aws:s3:::*"
            }
          ]
        }
      }
},
    "TravisUploadToS3": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
	"Users" : ["travis"],
        "PolicyName": "Travis-Upload-To-S3",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "s3:PutObject"
              ],
              "Resource": [
                "arn:aws:s3:::*"
              ]
            }
          ]
        }
      }
},
"TravisCodeDeploy": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
	"Users" : ["travis"],
        "PolicyName": "Travis-Code-Deploy",
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "codedeploy:RegisterApplicationRevision",
                "codedeploy:GetApplicationRevision"
              ],
              "Resource": {"Fn::Join":
              ["", ["arn:aws:codedeploy:us-east-1:",{"Ref":"AWS::AccountId"},":application:csye6225-spring2018"
              ]]}
            },
            {
              "Effect": "Allow",
              "Action": [
                "codedeploy:CreateDeployment",
                "codedeploy:GetDeployment"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "codedeploy:GetDeploymentConfig"
              ],
              "Resource": [
                {"Fn::Join":
                ["", ["arn:aws:codedeploy:us-east-1:",{"Ref":"AWS::AccountId"},":deploymentconfig:CodeDeployDefault.OneAtATime"
                ]]},
                {"Fn::Join":
                ["", ["arn:aws:codedeploy:us-east-1:",{"Ref":"AWS::AccountId"},":deploymentconfig:CodeDeployDefault.HalfAtATime"
                ]]},
                {"Fn::Join":
                ["", ["arn:aws:codedeploy:us-east-1:",{"Ref":"AWS::AccountId"},":CodeDeployDefault.AllAtOnce"
                ]]}
              ]
            }
          ]
        }
      }
},
    "CodeDeployEC2ServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": ["ec2.amazonaws.com"]
            },
            "Action": ["sts:AssumeRole"]
          }]
        },
        "Path": "/",
	"ManagedPolicyArns":["arn:aws:iam::aws:policy/AdministratorAccess"],
        "RoleName": "CodeDeployEC2ServiceRole"
      }
},

 "CodeDeployServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
          "Statement": [ {
            "Effect": "Allow",
            "Principal": {
              "Service": [ "codedeploy.amazonaws.com" ]
            },
            "Action": [ "sts:AssumeRole" ]
          } ]
        },
        "Path": "/",
        "ManagedPolicyArns":["arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"],
        "RoleName":"CodeDeployServiceRole"
      }
},
	"CodeDeployS3Bucket" : {
	"Type" : "AWS::S3::Bucket",
  	"Properties" : {
	    "BucketName" : "code-deploy.csye6225-spring2018-guodong.me"
	 }
     },
      "CodeDeployApplication" : {
	"Type" : "AWS::CodeDeploy::Application",
  	"Properties" : {
    	    "ApplicationName" : "csye6225-spring2018-codedeploy"
  	}
     },
      "CodeDeploymentGroup" : {
		
	 "Type" : "AWS::CodeDeploy::DeploymentGroup",
  	 "Properties" : {
    	 "ApplicationName" : "csye6225-spring2018-codedeploy",
    	 "DeploymentConfigName" : "CodeDeployDefault.OneAtATime",
    	 "DeploymentGroupName" : "csye6225-spring2018-codedeploy",
    	 "DeploymentStyle" : {"DeploymentOption" : "WITHOUT_TRAFFIC_CONTROL", "DeploymentType" : "IN_PLACE"},
    	 "Ec2TagFilters" : [{"Key" : "deploy", "Type" : "KEY_AND_VALUE", "Value" : "deploy"}],
    	 "ServiceRoleArn" : { "Fn::GetAtt" : [ "CodeDeployServiceRole", "Arn" ] }
  	 }
     }
},

    "Parameters" : {
        "InstanceName" : {
            "Type" : "String"
        },
	"SubnetId" : {
	    "Type" : "String"
	}
    }


}
