{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Sample CloudFormation Template for CSYE 6225 - Spring 2018",
  "Mappings": {
    "RegionMap": {
      "us-east-1": {
        "32": "ami-6411e20d",
        "64": "ami-7a11e213"
      }
    }
  },
  "Conditions": {},
  "Parameters": {
    "S3BucketName": {
      "Type": "String",
      "Default": "csye6225-spring2018-sunrui.me",
      "AllowedValues": [
        "csye6225-spring2018-sunrui.me",
        "csye6225-spring2018-xueti.me",
        "csye6225-spring2018-chaiyi.me"
      ]
    }
  },
  "Resources": {
    "InstanceSecurityGroupForWeb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupName": "csye6225-webapp",
        "GroupDescription": "Enable HTTP access via port 80, SSH access via port 22, HTTPS access via port 443",
        "VpcId": {
          "Ref": "myVPC"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": "80",
            "ToPort": "80",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "22",
            "ToPort": "22",
            "CidrIp": "0.0.0.0/0"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": "443",
            "ToPort": "443",
            "CidrIp": "0.0.0.0/0"
          }
        ]
      }
    },
    "myEC2InstanceForWeb": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "ImageId": "ami-66506c1c",
        "InstanceType": "t2.micro",
        "SecurityGroupIds": [
          {
            "Ref": "InstanceSecurityGroupForWeb"
          }
        ],
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "VolumeType": "gp2",
              "VolumeSize": "16",
              "DeleteOnTermination": "false"
            }
          }
        ],
        "SubnetId": {
          "Ref": "mySubnet1"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [
                  {
                    "Ref": "AWS::StackName"
                  },
                  "-csye6225-ec2instanceforweb"
                ]
              ]
            }
          }
        ]
      }
    },
    "myRDSInstanceSecurityGroup": {
      "Type": "AWS::RDS::DBSecurityGroup",
      "Properties": {
        "GroupDescription": "Ingress for Amazon EC2 security group",
        "EC2VpcId": {
          "Ref": "myVPC"
        },
        "DBSecurityGroupIngress": [
          {
            "EC2SecurityGroupId": {
              "Ref": "InstanceSecurityGroupForWeb"
            }
          }
        ]
      }
    },
    "myRDSInstance": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "DBName": "myRDSInstance",
        "AllocatedStorage": "100",
        "DBInstanceClass": "db.t2.medium",
        "MultiAZ": false,
        "DBInstanceIdentifier": "csye6225-spring2018",
        "Engine": "MySQL",
        "EngineVersion": "5.6.37",
        "MasterUsername": "csye6225master",
        "MasterUserPassword": "csye6225password",
        "PubliclyAccessible": false,
        "DBSubnetGroupName": {
          "Ref": "myDBSubnetGroup"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "csye6225"
          }
        ]
      },
      "DeletionPolicy": "Snapshot"
    },
    "myS3Bucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketName": {
          "Ref": "S3BucketName"
        }
      }
    }
  }
}
